<ng-container *ngIf="(vm$ | async) as t; else notFound">
  <section class="bg-white">
    <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">

      <!-- Header + Quick How-To (hidden while player is active) -->
      <div class="grid grid-cols-1 gap-10 lg:grid-cols-3" *ngIf="!isActive()">
        <!-- Header -->
        <div class="lg:col-span-2">
          <div class="flex items-center gap-4">
            <!-- BACK -->
            <button
              type="button"
              (click)="back()"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 active:translate-y-px active:shadow focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400/60 transition-colors select-none"
              aria-label="Go back"
            >
              <span class="-ml-1 text-lg leading-none">←</span>
              <span>Back</span>
            </button>

            <h1 class="text-3xl font-semibold tracking-tight text-slate-900">
              {{ t.name }}
            </h1>

            <!-- NEXT (anchor styled exactly like the Back button) -->
            <a
              *ngIf="(nextSlug$ | async) as nextSlug"
              [routerLink]="['/technique', nextSlug]"
              role="button"
              aria-label="Next technique"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 active:translate-y-px active:shadow focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400/60 transition-colors select-none"
            >
              <span>Next</span>
              <span class="-mr-1 text-lg leading-none">→</span>
            </a>
          </div>


          <p class="mt-3 max-w-2xl text-[15px] leading-7 text-slate-600">
            {{ t.description }}
          </p>

          <div class="mt-4 flex flex-wrap gap-2">
            <app-breath-chip *ngFor="let c of t.categories" [label]="c"></app-breath-chip>
          </div>
        </div>

        <!-- Quick How-To -->
        <aside class="lg:sticky lg:top-8">
          <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex items-center justify-between">
              <div class="text-[15px] font-semibold text-slate-900">How to</div>
              <span *ngIf="t.how_to" class="rounded-lg bg-slate-100 px-2 py-0.5 text-[11px] font-medium tracking-wide text-slate-600">
                {{ t.how_to }}
              </span>
            </div>

            <ul class="mt-3 space-y-2">
              <li *ngFor="let line of t._quick" class="flex gap-3 text-[13px] leading-6 text-slate-700">
                <svg class="mt-1 h-2.5 w-2.5 flex-none text-slate-900" viewBox="0 0 6 6" fill="currentColor" aria-hidden="true">
                  <circle cx="3" cy="3" r="3" />
                </svg>
                <span>{{ line }}</span>
              </li>
            </ul>
          </div>
        </aside>
      </div>

      <!-- Player card (always visible) -->
      <div class="mt-10 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm lg:p-8">
        <app-breathing-player
          [phases]="t._phases"
          (activeChange)="isActive.set($event)"
        ></app-breathing-player>
      </div>

      <!-- Benefits (hidden while player is active) -->
      <div class="mt-10" *ngIf="!isActive()">
        <div class="mb-4 flex items-center gap-3">
          <h2 class="text-sm font-semibold tracking-wide text-slate-900">Benefits</h2>
          <div class="h-px flex-1 bg-slate-200"></div>
        </div>

        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <article
            *ngFor="let b of t._benefits"
            class="group rounded-2xl border border-slate-200 bg-white p-5 shadow-sm ring-1 ring-transparent transition-all hover:-translate-y-0.5 hover:shadow-md hover:ring-4"
            [ngClass]="hoverRingClasses(iconForBenefit(b.title, b.note))"
          >
            <div
              class="mx-auto flex h-10 w-10 items-center justify-center rounded-full ring-2"
              [ngClass]="chipClasses(iconForBenefit(b.title, b.note))"
            >
              <lucide-icon
                [name]="iconForBenefit(b.title, b.note).name"
                class="h-5 w-5"
                [ngClass]="applyFg(iconForBenefit(b.title, b.note))"
                aria-hidden="true"
              ></lucide-icon>
            </div>

            <h3 class="mt-3 text-center text-[14px] font-semibold text-slate-900">
              {{ b.title }}
            </h3>
            <p class="mt-1 text-center text-[12px] leading-5 text-slate-600">
              {{ b.note }}
            </p>
          </article>
        </div>
      </div>

           <!-- Further Information (hidden while player is active) -->
<div class="mt-10" *ngIf="!isActive() && t.more_information?.length">
  <div class="mb-4 flex items-center gap-3">
    <h2 class="text-sm font-semibold tracking-wide text-slate-900">
      Further Information
    </h2>
    <div class="h-px flex-1 bg-slate-200"></div>
  </div>

  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <article
      *ngFor="let b of t.more_information"
      class="group rounded-2xl border border-slate-200 bg-white p-5 shadow-sm ring-1 ring-transparent transition-all hover:-translate-y-0.5 hover:shadow-md hover:ring-4"
      [ngClass]="hoverRingClasses(iconForBenefit(b.title))"
    >
      <h3 class=" text-center text-[14px] font-semibold text-slate-900">
        {{ b.title }}
      </h3>
    </article>
  </div>
</div>


    </div>
  </section>
</ng-container>

<ng-template #notFound>
  <div class="mx-auto max-w-3xl px-4 py-16 text-center">
    <div class="text-2xl font-semibold">Technique not found</div>
    <a routerLink="/" class="mt-4 inline-flex rounded-lg bg-black px-4 py-2 text-sm font-semibold text-white">Back home</a>
  </div>
</ng-template>
